<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Store Ranging App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      margin: 0;
      padding: 0;
      background: #f9fbfd;
      color: #333;
    }
    header {
      background: #007aff;
      color: white;
      padding: 14px;
      font-size: 20px;
      font-weight: 600;
      text-align: center;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .toolbar {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin: 12px;
    }
    button {
      border: none;
      border-radius: 8px;
      padding: 10px 16px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    button:active { transform: scale(0.96); }
    .refresh { background: #007aff; color: white; }
    .switch { background: #34c759; color: white; }
    .btn-small {
      padding: 6px 10px;
      border-radius: 6px;
      font-size: 13px;
      margin-top: 4px;
    }
    .btn-small.add { background: #007aff; color: white; }
    .btn-small.add.added { background: #34c759; }
    .btn-small.not { background: #ff3b30; color: white; }
    .section { margin: 16px; }
    .summary {
      background: #eaf4ff;
      border-radius: 10px;
      padding: 10px 14px;
      margin-bottom: 12px;
      font-weight: 500;
    }
    .card {
      background: white;
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 14px;
      display: flex;
      gap: 12px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.08);
    }
    .thumb {
      flex: 0 0 70px;
      height: 70px;
      border-radius: 8px;
      background: #f0f0f0;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }
    .thumb img { width: 100%; height: 100%; object-fit: contain; }
    .card .title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 6px;
    }
    .card .meta {
      font-size: 13px;
      color: #555;
      margin-bottom: 3px;
    }
    .button-row {
      display: flex;
      gap: 8px;
      margin-top: 6px;
    }
    .hidden { display: none; }
    .debug {
      background: #fef5e7;
      border-radius: 10px;
      padding: 10px;
      font-size: 12px;
      margin: 16px;
      color: #666;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <header>üì± Store Ranging App</header>

  <div class="toolbar">
    <button class="refresh" onclick="loadData()">üîÑ Refresh</button>
    <button class="switch" onclick="toggleView()">üìä Switch to Dashboard</button>
  </div>

  <div class="section">
    <label for="storeSelect">Select a store:</label>
    <select id="storeSelect" onchange="renderStoreView()">
      <option value="">-- Choose a store --</option>
    </select>
  </div>

  <div class="section hidden" id="dealSummary">
    <div class="summary">üí∞ Total Deal Offer Summary: <span id="totalOffer">$0.00</span></div>
  </div>

  <div class="section" id="storeCards"></div>

  <div class="section">
    <h3>üõ†Ô∏è Debug Output</h3>
    <div class="debug" id="debugOutput">Loading‚Ä¶</div>
  </div>

  <script>
    const scriptUrl = "YOUR_SCRIPT_URL_HERE"; // <-- replace with your Apps Script URL
    let rawRows = [];
    let productsIndex = new Map();
    let selectedStore = "";
    let offerSet = new Set();
    let totalOfferValue = 0;

    const storeSelect = document.getElementById("storeSelect");
    const storeCards = document.getElementById("storeCards");
    const totalOffer = document.getElementById("totalOffer");
    const dealSummary = document.getElementById("dealSummary");
    const debugOutput = document.getElementById("debugOutput");

    async function loadData() {
      try {
        debugOutput.textContent = "Loading...";
        const res = await fetch(scriptUrl);
        const data = await res.json();
        rawRows = data.ranging || [];
        productsIndex = new Map((data.deals || []).map(d => [d.Product.toLowerCase(), d]));
        debugOutput.textContent = "Loaded rows: " + rawRows.length;
        populateStores();
        if (selectedStore) renderStoreView();
      } catch (err) {
        debugOutput.textContent = "Error: " + err;
      }
    }

    function populateStores() {
      const stores = [...new Set(rawRows.map(r => r.Store))];
      storeSelect.innerHTML = '<option value="">-- Choose a store --</option>';
      stores.forEach(s => {
        const opt = document.createElement("option");
        opt.value = s;
        opt.textContent = s;
        storeSelect.appendChild(opt);
      });
    }

    function norm(str) { return (str || "").toLowerCase().trim(); }

    function renderStoreView() {
      selectedStore = norm(storeSelect.value);
      storeCards.innerHTML = "";
      if (!selectedStore) { dealSummary.classList.add('hidden'); return; }
      dealSummary.classList.remove('hidden');

      const rows = rawRows.filter(r => norm(r.Store) === selectedStore);
      if (rows.length === 0) { storeCards.innerHTML = "<div>No products found.</div>"; return; }

      for (const r of rows) {
        const product = norm(r.Product);
        const meta = productsIndex.get(product) || {};
        const img = meta["Image URL"];
        const isAdded = offerSet.has(product);

        const card = document.createElement('div');
        card.className = "card";
        card.innerHTML = `
          <div class="thumb">${img ? `<img src="${img}">` : "üñºÔ∏è"}</div>
          <div>
            <div class="title">${r.Product}</div>
            <div class="meta">Metcash Code: ${meta["Metcash Code"] || "-"}</div>
            <div class="meta">SDA Ranking: ${meta["SDA Ranking"] || "-"}</div>
            <div class="meta">Category: ${meta["Category"] || "-"}</div>
            <div class="meta">Layout: ${meta["Metcash Layout"] || "-"}</div>
            <div class="meta">Base Range: ${meta["Metcash Base Range"] || "-"}</div>
            <div class="meta">List Price: ${meta["List Price"] || "-"}</div>
            <div class="meta">50% Deal: ${meta["50% Deal"] || "-"}</div>
            <div class="meta">Status: ${r.Status || "-"}</div>
            <div class="button-row">
              <button class="btn-small add ${isAdded ? "added" : ""}">
                ${isAdded ? "Added" : "Add to Offer"}
              </button>
              <button class="btn-small not">Not Buying</button>
            </div>
          </div>`;

        const addBtn = card.querySelector(".add");
        addBtn.addEventListener("click", () => toggleOffer(product, meta["50% Deal"], addBtn));

        const notBtn = card.querySelector(".not");
        notBtn.addEventListener("click", () => card.remove());

        storeCards.appendChild(card);
      }
    }

    function toggleOffer(product, dealValueRaw, btn) {
      const val = parseFloat((dealValueRaw || "0").toString().replace(/[^0-9.]/g, "")) || 0;
      if (offerSet.has(product)) {
        offerSet.delete(product);
        totalOfferValue -= val;
        btn.classList.remove("added");
        btn.textContent = "Add to Offer";
      } else {
        offerSet.add(product);
        totalOfferValue += val;
        btn.classList.add("added");
        btn.textContent = "Added";
      }
      totalOffer.textContent = "$" + totalOfferValue.toFixed(2);
    }

    function toggleView() {
      alert("Dashboard view not included in this snippet yet. Store view working.");
    }

    loadData();
  </script>
</body>
</html>