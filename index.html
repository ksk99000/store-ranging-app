<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Store Ranging App</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1 { font-size: 1.5em; }
    select, button { margin: 10px 0; padding: 5px; }
    .product-card {
      border: 1px solid #ccc; border-radius: 6px; padding: 10px;
      margin-bottom: 10px; display: flex; justify-content: space-between;
      align-items: center; background: #f9f9f9;
    }
    .product-info { flex: 1; margin-left: 10px; }
    .actions button { margin-left: 5px; }
    img { width: 50px; height: 50px; object-fit: contain; }
  </style>
</head>
<body>
  <h1>Store Ranging App</h1>
  <button onclick="fetchData()">Refresh</button>
  <br>
  <label for="storeSelect">Select a store:</label>
  <select id="storeSelect" onchange="renderProducts()">
    <option value="">-- Choose a store --</option>
  </select>
  <div id="products"></div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbwZBkRpAIrRVNZ5mt-g_AX7_OjOd3-bTwAwBEihMMYLRlkBEiX9f8f566NAXZEyZMND/exec";
    let allData = [];

    async function fetchData() {
      try {
        const res = await fetch(API_URL);
        allData = await res.json();

        // Normalize and extract store names
        const stores = [...new Set(allData.map(row => row.Store || row.store))];

        const select = document.getElementById("storeSelect");
        select.innerHTML = `<option value="">-- Choose a store --</option>`;
        stores.forEach(store => {
          if (store) {
            const opt = document.createElement("option");
            opt.value = store;
            opt.textContent = store;
            select.appendChild(opt);
          }
        });
      } catch (err) {
        console.error("Error fetching data", err);
      }
    }

    function renderProducts() {
      const store = document.getElementById("storeSelect").value;
      const container = document.getElementById("products");
      container.innerHTML = "";

      if (!store) return;

      const products = allData.filter(row =>
        (row.Store || row.store) === store &&
        (row.Status || row.status) === "Not Ranging"
      );

      products.forEach(prod => {
        const productName = prod.Product || prod.product || "Unnamed product";
        const metcash = prod.MetcashCode || prod.metcashCode || "—";
        const deal = prod["50% Deal"] || prod.deal || "—";
        const image = prod["Image URL"] || prod.image || "";

        const card = document.createElement("div");
        card.className = "product-card";
        card.innerHTML = `
          <img src="${image || 'https://via.placeholder.com/50'}" alt="Product">
          <div class="product-info">
            <strong>${productName}</strong><br>
            Metcash Code: ${metcash}<br>
            50% Deal: $${deal}
          </div>
          <div class="actions">
            <button onclick="addToOffer('${store}','${productName}')">Add to Offer</button>
            <button onclick="notBuying('${store}','${productName}')">Not Buying</button>
          </div>
        `;
        container.appendChild(card);
      });
    }

    async function addToOffer(store, product) {
      alert(`Added ${product} from ${store} to offer`);
      // Hook this to your sheet if needed
    }

    async function notBuying(store, product) {
      try {
        await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            Store: store,
            Product: product,
            Status: "Not Buying"
          })
        });
        alert(`Marked ${product} as Not Buying for ${store}`);
        fetchData(); // Refresh data
      } catch (err) {
        console.error("Error sending Not Buying update", err);
      }
    }

    // Initial load
    fetchData();
  </script>
</body>
</html>