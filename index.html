<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Store Ranging App</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen">
  <header class="bg-white shadow p-4 flex justify-between items-center">
    <h1 class="text-xl font-bold">Store Ranging App</h1>
    <button id="refresh-btn" class="px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700">Refresh</button>
  </header>

  <main class="p-4">
    <div id="deal-offer-box" class="mb-4 p-4 bg-blue-100 border border-blue-200 rounded-lg hidden">
      <h3 class="font-bold text-lg text-blue-800">Total Deal Offer Summary</h3>
      <p class="text-sm text-blue-600">Based on 50% Deal Price</p>
      <p id="deal-total" class="text-3xl font-bold text-blue-900 mt-1">$0.00</p>
      <ul id="deal-list" class="mt-2 text-sm list-disc list-inside text-slate-700 space-y-1"></ul>
    </div>

    <div class="mb-4">
      <label class="block mb-2 font-semibold">Select a store</label>
      <select id="store-select" class="w-full border rounded p-2"></select>
    </div>

    <div id="product-grid" class="space-y-3"></div>
  </main>

  <script>
    // ✅ Your live Apps Script URL
    const webAppUrl = 'https://script.google.com/macros/s/AKfycbwZBkRpAIrRVNZ5mt-g_AX7_OjOd3-bTwAwBEihMMYLRlkBEiX9f8f566NAXZEyZMND/exec';

    let rangingData = [];
    let dealsData = [];
    let dealsIndex = new Map();
    let selectedDeals = {};

    function normName(s) {
      return String(s || "")
        .replace(/^[*"'`]+/, "")
        .replace(/\s+/g, " ")
        .trim()
        .toUpperCase();
    }

    function buildDealsIndex() {
      dealsIndex = new Map();
      dealsData.forEach(d => {
        const key = normName(d.product);
        if (key && !dealsIndex.has(key)) dealsIndex.set(key, d);
      });
    }

    async function fetchData() {
      try {
        const res = await fetch(webAppUrl);
        const data = await res.json();
        rangingData = data.rangingData || [];
        dealsData = data.dealsData || [];
        buildDealsIndex();
        populateStores();
      } catch (err) {
        console.error("Error fetching data", err);
      }
    }

    function populateStores() {
      const select = document.getElementById("store-select");
      select.innerHTML = '<option value="">-- Choose a store --</option>';
      const stores = [...new Set(rangingData.map(r => r[0]))].sort();
      stores.forEach(store => {
        const opt = document.createElement("option");
        opt.value = store;
        opt.textContent = store;
        select.appendChild(opt);
      });
    }

    function showStoreProducts(store) {
      const grid = document.getElementById("product-grid");
      grid.innerHTML = "";
      if (!store) return;

      const rows = rangingData.filter(r => r[0] === store && r[2] === "Not Ranging");
      rows.forEach(row => {
        const productName = row[1];
        const deal = dealsIndex.get(normName(productName)) || null;

        const metcashCode = deal?.metcashcode ?? deal?.["Metcash Code"] ?? "—";
        const fiftyPercentDeal = deal?.["50deal"] ?? deal?.["50% Deal"] ?? "—";
        const imageUrl = deal?.imageurl || "https://placehold.co/100x100?text=No+Image";

        const card = document.createElement("div");
        card.className = "bg-white rounded shadow p-3";

        const isSelected = selectedDeals[productName];
        card.innerHTML = `
          <div class="flex items-center space-x-4">
            <img src="${imageUrl}" alt="${productName}" class="w-16 h-16 rounded object-cover">
            <div class="flex-1">
              <div class="font-semibold">${productName}</div>
              <div class="text-xs text-slate-600">Metcash Code: ${metcashCode}</div>
              <div class="text-xs text-slate-600">50% Deal: $${fiftyPercentDeal}</div>
            </div>
            <button class="px-3 py-1 rounded text-white text-sm ${isSelected ? 'bg-green-600' : 'bg-blue-600'}">
              ${isSelected ? 'Added' : 'Add to Offer'}
            </button>
          </div>
        `;

        const btn = card.querySelector("button");
        btn.addEventListener("click", () => toggleDeal(productName, fiftyPercentDeal, btn));
        grid.appendChild(card);
      });

      renderDealSummary();
    }

    function toggleDeal(productName, dealPrice, btn) {
      if (selectedDeals[productName]) {
        delete selectedDeals[productName];
      } else {
        selectedDeals[productName] = parseFloat(dealPrice) || 0;
      }
      btn.className = `px-3 py-1 rounded text-white text-sm ${selectedDeals[productName] ? 'bg-green-600' : 'bg-blue-600'}`;
      btn.textContent = selectedDeals[productName] ? "Added" : "Add to Offer";
      renderDealSummary();
    }

    function renderDealSummary() {
      const box = document.getElementById("deal-offer-box");
      const totalEl = document.getElementById("deal-total");
      const list = document.getElementById("deal-list");

      const entries = Object.entries(selectedDeals);
      if (entries.length === 0) {
        box.classList.add("hidden");
        return;
      }

      box.classList.remove("hidden");
      let total = 0;
      list.innerHTML = "";
      entries.forEach(([name, price]) => {
        total += price;
        const li = document.createElement("li");
        li.textContent = `${name} - $${price.toFixed(2)}`;
        list.appendChild(li);
      });
      totalEl.textContent = `$${total.toFixed(2)}`;
    }

    document.getElementById("store-select").addEventListener("change", e => {
      showStoreProducts(e.target.value);
    });

    document.getElementById("refresh-btn").addEventListener("click", fetchData);

    fetchData();
  </script>
</body>
</html>