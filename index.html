<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ðŸ“± Store Ranging App</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: #f9fbfd;
      color: #333;
    }
    header {
      background: #007aff;
      color: white;
      padding: 14px;
      font-size: 20px;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .container {
      padding: 15px;
    }
    button {
      border: none;
      border-radius: 8px;
      padding: 10px 14px;
      margin: 5px;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      color: white;
    }
    .refresh { background: #007aff; }
    .dashboard { background: #34c759; }
    .add { background: #007aff; }
    .added { background: #34c759; }
    .not { background: #ff3b30; }
    .product-card {
      background: #fff;
      padding: 12px;
      margin: 10px 0;
      border-radius: 12px;
      display: flex;
      align-items: center;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }
    .product-card img {
      width: 70px;
      height: 70px;
      object-fit: contain;
      border-radius: 8px;
      margin-right: 12px;
      border: 1px solid #eee;
    }
    .product-info {
      flex: 1;
    }
    .debug {
      background: #fff3cd;
      color: #856404;
      padding: 10px;
      margin-top: 10px;
      border: 1px solid #ffeeba;
      border-radius: 6px;
      font-size: 12px;
      font-family: monospace;
    }
  </style>
</head>
<body>
  <header>ðŸ“± Store Ranging App</header>
  <div class="container">
    <button class="refresh" onclick="loadData()">ðŸ”„ Refresh</button>
    <button class="dashboard" onclick="toggleView()">ðŸ“Š Switch to Dashboard</button>

    <div id="storeView">
      <label for="storeSelect">Select a store:</label>
      <select id="storeSelect" onchange="renderStoreProducts()"></select>

      <h3>Total Deal Offer Summary</h3>
      <div id="dealSummary">$0.00</div>

      <h3>Products</h3>
      <div id="products"></div>
    </div>

    <div id="dashboardView" style="display:none;">
      <h3>ðŸ“Š Product Dashboard</h3>
      <div id="dashboard"></div>
    </div>

    <h3>ðŸ›  Debug Output</h3>
    <pre id="debug" class="debug"></pre>
  </div>

  <script>
    const scriptUrl = "https://script.google.com/macros/s/AKfycbwjs8iFcXbkXPcYbcvqAgKtU2grsMuxcoOOVY8Aox3nXppahHuktklIf7snHC86yN907Q/exec";
    let storeData = [];
    let productData = [];
    let dealTotal = 0;
    let addedProducts = new Map();

    async function loadData() {
      try {
        const res = await fetch(scriptUrl);
        const text = await res.text();

        if (!text.startsWith("{") && !text.startsWith("[")) {
          document.getElementById("debug").textContent = "Error: Response is not valid JSON.\n" + text;
          return;
        }

        const data = JSON.parse(text);
        storeData = data.ranging || [];
        productData = data.deals || [];

        document.getElementById("debug").textContent = "Loaded " + storeData.length + " ranging rows & " + productData.length + " products.";

        populateStoreDropdown();
      } catch (err) {
        document.getElementById("debug").textContent = "Error loading data: " + err;
      }
    }

    function populateStoreDropdown() {
      const select = document.getElementById("storeSelect");
      select.innerHTML = '<option>-- Choose a store --</option>';
      [...new Set(storeData.map(r => r.Store))].forEach(store => {
        const opt = document.createElement("option");
        opt.value = store;
        opt.textContent = store;
        select.appendChild(opt);
      });
    }

    function renderStoreProducts() {
      const store = document.getElementById("storeSelect").value;
      const container = document.getElementById("products");
      container.innerHTML = "";

      if (!store || store === "-- Choose a store --") return;

      const products = storeData.filter(r => r.Store === store && r.Status.toLowerCase() !== "ranging");
      products.forEach(r => {
        const info = productData.find(p => p.Product === r.Product) || {};
        const price = parseFloat((info['50% Deal'] || "0").toString().replace(/[^0-9.]/g, "")) || 0;

        const card = document.createElement("div");
        card.className = "product-card";
        card.innerHTML = `
          <img src="${info['Image URL'] || ''}" alt="Product">
          <div class="product-info">
            <strong>${r.Product}</strong><br>
            Metcash Code: ${info['Metcash Code'] || '-'}<br>
            List Price: ${info['List Price'] || '-'}<br>
            50% Deal: ${info['50% Deal'] || '-'}
            <div>
              <button class="add" id="btn-${r.Product.replace(/\s+/g, "_")}"
                onclick="toggleDeal('${r.Product.replace(/'/g, "\\'")}', ${price})">
                Add to Offer
              </button>
              <button class="not" onclick="removeProduct('${r.Product.replace(/'/g, "\\'")}')">Not Buying</button>
            </div>
          </div>`;
        container.appendChild(card);
      });
    }

    function toggleDeal(product, price) {
      const btn = document.getElementById("btn-" + product.replace(/\s+/g, "_"));
      if (!btn) return;

      if (addedProducts.has(product)) {
        addedProducts.delete(product);
        dealTotal -= price;
        btn.textContent = "Add to Offer";
        btn.className = "add";
      } else {
        addedProducts.set(product, price);
        dealTotal += price;
        btn.textContent = "Added";
        btn.className = "added";
      }
      document.getElementById("dealSummary").textContent = "$" + dealTotal.toFixed(2);
    }

    function removeProduct(product) {
      const container = document.getElementById("products");
      [...container.children].forEach(card => {
        if (card.innerText.includes(product)) {
          card.remove();
        }
      });
    }

    function toggleView() {
      const storeView = document.getElementById("storeView");
      const dashboardView = document.getElementById("dashboardView");
      if (storeView.style.display === "none") {
        storeView.style.display = "";
        dashboardView.style.display = "none";
      } else {
        storeView.style.display = "none";
        dashboardView.style.display = "";
      }
    }

    loadData();
  </script>
</body>
</html>