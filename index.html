<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Store Ranging & Deals App</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .hidden { display: none; }
    .status-bar { height: 8px; border-radius: 4px; margin-top: 4px; }
  </style>
</head>
<body class="bg-slate-100 text-slate-800">

  <div class="h-screen flex flex-col">
    <main class="w-full flex-grow flex flex-col bg-slate-50">
      <header class="p-4 border-b border-slate-200 bg-white flex justify-between items-center">
        <h2 class="text-xl font-bold">Store Ranging App</h2>
        <div class="space-x-2">
          <button id="dashboard-btn" class="px-3 py-1 bg-gray-600 text-white rounded-md text-sm">Dashboard üìä</button>
          <button id="store-btn" class="px-3 py-1 bg-blue-600 text-white rounded-md text-sm">Stores üè¨</button>
          <button id="refresh-btn" class="px-3 py-1 bg-green-600 text-white rounded-md text-sm">Refresh üîÑ</button>
        </div>
      </header>

      <div class="flex-grow p-4 overflow-y-auto">
        <!-- Dashboard -->
        <div id="dashboard-view">
          <div id="dashboard-loader" class="text-center p-8 flex flex-col items-center justify-center">
            <div class="loader mx-auto"></div>
            <p class="mt-2 text-slate-500">Loading data...</p>
          </div>
          <div id="dashboard-grid" class="grid grid-cols-1 md:grid-cols-3 gap-4 hidden"></div>
        </div>

        <!-- Store View -->
        <div id="store-view" class="hidden">
          <div id="deal-summary" class="mb-4 p-4 bg-blue-100 border border-blue-200 rounded-lg hidden">
            <h3 class="font-bold text-lg text-blue-800">Total Deal Offer Summary</h3>
            <p class="text-sm text-blue-600">Based on selected products</p>
            <p id="deal-total" class="text-3xl font-bold text-blue-900 mt-1">$0.00</p>
            <ul id="deal-list" class="mt-2 text-sm list-disc list-inside text-slate-700 space-y-1"></ul>
          </div>

          <h3 class="font-bold text-lg mb-2">Stores</h3>
          <ul id="store-list" class="space-y-2"></ul>

          <div id="products-section" class="mt-6 hidden">
            <h3 id="products-title" class="font-bold text-lg mb-2"></h3>
            <div id="products-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script>
    const dataUrl = "https://api.sheetbest.com/sheets/8c337928-5dd1-41bb-9c49-00b1e423f241";

    let rangingData = [];
    let selectedDeals = [];

    document.addEventListener("DOMContentLoaded", () => {
      loadData();

      document.getElementById("refresh-btn").addEventListener("click", loadData);
      document.getElementById("dashboard-btn").addEventListener("click", () => {
        showDashboard();
      });
      document.getElementById("store-btn").addEventListener("click", () => {
        showStores();
      });
    });

    async function loadData() {
      try {
        document.getElementById("dashboard-loader").style.display = "block";
        document.getElementById("dashboard-grid").classList.add("hidden");

        const res = await fetch(dataUrl);
        if (!res.ok) throw new Error("HTTP error " + res.status);
        const data = await res.json();
        rangingData = data;

        renderDashboard(data);
        renderStores(data);
      } catch (err) {
        console.error("Failed to load data", err);
        document.getElementById("dashboard-grid").innerHTML = "<p class='text-red-500'>‚ö†Ô∏è Error loading data</p>";
        document.getElementById("dashboard-grid").classList.remove("hidden");
      } finally {
        document.getElementById("dashboard-loader").style.display = "none";
      }
    }

    // --- Dashboard ---
    function renderDashboard(data) {
      const grid = document.getElementById("dashboard-grid");
      grid.innerHTML = "";

      data.forEach(item => {
        const card = document.createElement("div");
        card.className = "p-4 bg-white shadow rounded flex flex-col";

        card.innerHTML = `
          <img src="${item["Image URL"] || ''}" alt="${item.Product}" class="w-full h-40 object-cover rounded mb-2">
          <h3 class="font-bold text-md">${item.Product}</h3>
          <div class="status-bar ${item.Ranging.toLowerCase() === "ranging" ? "bg-green-500" : "bg-red-500"}"></div>
          <p class="text-sm mt-1">${item.Ranging}</p>
        `;

        grid.appendChild(card);
      });

      grid.classList.remove("hidden");
    }

    // --- Stores ---
    function renderStores(data) {
      const storeList = document.getElementById("store-list");
      storeList.innerHTML = "";

      const stores = [...new Set(data.map(r => r.Store))];
      stores.forEach(store => {
        const li = document.createElement("li");
        li.className = "p-3 bg-white shadow rounded cursor-pointer hover:bg-slate-100";
        li.textContent = store;
        li.addEventListener("click", () => showStoreProducts(store));
        storeList.appendChild(li);
      });
    }

    function showStoreProducts(store) {
      const section = document.getElementById("products-section");
      const title = document.getElementById("products-title");
      const grid = document.getElementById("products-grid");

      title.textContent = `Not Ranging Products for ${store}`;
      grid.innerHTML = "";

      const products = rangingData.filter(r => r.Store === store && r.Ranging.toLowerCase() === "not ranging");

      products.forEach(prod => {
        const card = document.createElement("div");
        card.className = "p-4 bg-white shadow rounded flex flex-col";

        const isSelected = selectedDeals.find(d => d.Product === prod.Product);

        card.innerHTML = `
          <img src="${prod["Image URL"] || ''}" alt="${prod.Product}" class="w-full h-40 object-cover rounded mb-2">
          <h3 class="font-bold text-md">${prod.Product}</h3>
          <button class="deal-btn mt-2 px-3 py-1 rounded ${isSelected ? "bg-green-600 text-white" : "bg-blue-600 text-white"}">
            ${isSelected ? "Added" : "Add to Deal"}
          </button>
        `;

        const btn = card.querySelector(".deal-btn");
        btn.addEventListener("click", () => toggleDeal(prod, btn));

        grid.appendChild(card);
      });

      section.classList.remove("hidden");
      updateDealSummary();
    }

    // --- Deal Summary ---
    function toggleDeal(product, btn) {
      const index = selectedDeals.findIndex(d => d.Product === product.Product);
      if (index >= 0) {
        selectedDeals.splice(index, 1);
        btn.textContent = "Add to Deal";
        btn.className = "deal-btn mt-2 px-3 py-1 rounded bg-blue-600 text-white";
      } else {
        selectedDeals.push(product);
        btn.textContent = "Added";
        btn.className = "deal-btn mt-2 px-3 py-1 rounded bg-green-600 text-white";
      }
      updateDealSummary();
    }

    function updateDealSummary() {
      const box = document.getElementById("deal-summary");
      const totalEl = document.getElementById("deal-total");
      const listEl = document.getElementById("deal-list");

      if (selectedDeals.length === 0) {
        box.classList.add("hidden");
        return;
      }

      box.classList.remove("hidden");
      listEl.innerHTML = "";

      // For now, we‚Äôll just count items (no price column in sheet?)
      let total = selectedDeals.length;

      totalEl.textContent = `${total} Products`;

      selectedDeals.forEach(prod => {
        const li = document.createElement("li");
        li.textContent = prod.Product;
        listEl.appendChild(li);
      });
    }

    // --- View Switchers ---
    function showDashboard() {
      document.getElementById("dashboard-view").classList.remove("hidden");
      document.getElementById("store-view").classList.add("hidden");
    }

    function showStores() {
      document.getElementById("dashboard-view").classList.add("hidden");
      document.getElementById("store-view").classList.remove("hidden");
    }
  </script>
</body>
</html>