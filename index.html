<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>üì± Store Ranging App</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: #f7f7f7;
    }
    h1 {
      color: #0066cc;
    }
    #debug {
      background: #fff3cd;
      border: 1px solid #ffeeba;
      padding: 10px;
      margin-top: 10px;
      white-space: pre-wrap;
      font-size: 12px;
    }
    select, button {
      padding: 8px;
      margin: 5px 0;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <h1>üì± Store Ranging App <span style="font-size:14px; color:gray;">v2.4.1 (17 Sept 2025)</span></h1>
  
  <button onclick="loadData()">üîÑ Refresh</button>
  <select id="storeSelect">
    <option value="">-- Select a store --</option>
  </select>

  <h2>Products</h2>
  <div id="products"></div>

  <h3>üõ† Debug Output</h3>
  <div id="debug"></div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbziovfnY9nAhZ6-hy6NVa3QTxdM3IpSDjEH7is2Dvfjw7Mne4p2_F-nlItY2dDu3Lt5/exec";
    let allData = {};

    async function loadData() {
      document.getElementById("debug").textContent = "‚è≥ Loading...";
      try {
        const res = await fetch(API_URL);
        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();
        allData = data;

        if (!data.success) throw new Error(data.error || "Unknown error");

        // --- Populate store dropdown from Data tab col B ---
        const storeSelect = document.getElementById("storeSelect");
        storeSelect.innerHTML = '<option value="">-- Select a store --</option>';
        const storeNames = [...new Set(data.data.map(row => row[1]))] // col B
                          .filter(s => s && s.trim() !== "");

        storeNames.forEach(store => {
          const opt = document.createElement("option");
          opt.value = store;
          opt.textContent = store;
          storeSelect.appendChild(opt);
        });

        document.getElementById("debug").textContent = 
          `‚úÖ Loaded ${storeNames.length} stores & ${data.data.length} rows from Data tab.`;

      } catch (err) {
        document.getElementById("debug").textContent = "‚ùå Fetch error: " + err.message;
      }
    }

    // Show products when a store is selected
    document.getElementById("storeSelect").addEventListener("change", function () {
      const selectedStore = this.value;
      const output = document.getElementById("products");

      if (!selectedStore) {
        output.innerHTML = "<em>No store selected</em>";
        return;
      }

      // Filter rows from Data tab (col B = store)
      const filtered = allData.data.filter(row => row[1] === selectedStore);

      if (filtered.length === 0) {
        output.innerHTML = "<em>No products found for this store</em>";
      } else {
        output.innerHTML = filtered.map(row => 
          `<div><strong>${row[2] || "(no product)"}</strong> ‚Äî ${row[3] || ""}</div>`
        ).join("");
      }
    });

    // Load immediately
    loadData();
  </script>
</body>
</html>