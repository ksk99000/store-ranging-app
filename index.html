<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ðŸ“± Store Ranging App</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background:#f9fbfd; margin:0; padding:20px; }
    h1 { color:#0066ff; font-size:22px; }
    select, button { padding:10px; margin:5px; border-radius:6px; border:1px solid #ccc; }
    button { cursor:pointer; }
    .product { background:#fff; border:1px solid #ddd; border-radius:10px; margin:10px 0; padding:15px; display:flex; align-items:center; }
    .product img { width:80px; height:80px; object-fit:contain; margin-right:15px; border-radius:8px; border:1px solid #ddd; }
    .info { flex:1; }
    .buttons { display:flex; gap:10px; margin-top:10px; }
    .add { background:#007bff; color:#fff; border:none; border-radius:6px; padding:8px 12px; }
    .add.added { background:#28a745; }
    .not { background:#ff4d4f; color:#fff; border:none; border-radius:6px; padding:8px 12px; }
    #summary { margin:15px 0; padding:10px; background:#e6f2ff; border-radius:8px; font-weight:bold; }
    pre { background:#f5f5f5; padding:10px; border-radius:6px; overflow:auto; }
  </style>
</head>
<body>
  <h1>ðŸ“± Store Ranging App</h1>
  <button onclick="loadData()">ðŸ”„ Refresh</button>
  <select id="storeSelect" onchange="renderProducts()">
    <option>-- Choose a store --</option>
  </select>

  <div id="summary">Total Deal Offer Summary: $0.00</div>
  <h2>Products</h2>
  <div id="products"></div>

  <h3>ðŸ›  Debug Output</h3>
  <pre id="debug">Waiting for dataâ€¦</pre>

  <script>
    const scriptUrl = "https://script.google.com/macros/s/AKfycbyuYCaMVexXexoUinDwIZsMrAUZlnSqpPcsp4Ytk_L443OyPl60tpMdryK5u0ztFq5riQ/exec";
    let allData = [];
    let dealSummary = {};

    async function loadData() {
      try {
        const res = await fetch(scriptUrl);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        allData = data;
        document.getElementById("debug").textContent = JSON.stringify(data.slice(0,5), null, 2);

        // Populate store dropdown
        const stores = [...new Set(data.map(d => d.Store))].sort();
        const select = document.getElementById("storeSelect");
        select.innerHTML = "<option>-- Choose a store --</option>";
        stores.forEach(s => {
          const opt = document.createElement("option");
          opt.value = s; opt.textContent = s;
          select.appendChild(opt);
        });
      } catch (err) {
        document.getElementById("debug").textContent = "Error loading: " + err;
      }
    }

    function renderProducts() {
      const store = document.getElementById("storeSelect").value;
      const container = document.getElementById("products");
      container.innerHTML = "";
      dealSummary = {};

      if (!store || store.includes("-- Choose")) return;

      const products = allData.filter(d => d.Store === store && d.Status === "not ranging");
      products.forEach(p => {
        const card = document.createElement("div");
        card.className = "product";
        card.innerHTML = `
          <img src="${p['Image URL'] || ''}" alt="Product">
          <div class="info">
            <strong>${p.Product}</strong><br>
            Metcash Code: ${p['Metcash Code'] || '-'}<br>
            Category: ${p['Category'] || '-'}<br>
            List Price: ${p['List Price'] || '-'}<br>
            50% Deal: ${p['50% Deal'] || '-'}<br>
            Status: ${p.Status}
            <div class="buttons">
              <button class="add" onclick="toggleOffer('${p.Product}', ${parseFloat(p['50% Deal'])||0}, this)">Add to Offer</button>
              <button class="not" onclick="this.closest('.product').remove()">Not Buying</button>
            </div>
          </div>
        `;
        container.appendChild(card);
      });
    }

    function toggleOffer(product, value, btn) {
      if (dealSummary[product]) {
        delete dealSummary[product];
        btn.textContent = "Add to Offer";
        btn.classList.remove("added");
      } else {
        dealSummary[product] = value;
        btn.textContent = "Added";
        btn.classList.add("added");
      }
      updateSummary();
    }

    function updateSummary() {
      const total = Object.values(dealSummary).reduce((a,b)=>a+b,0);
      document.getElementById("summary").textContent = "Total Deal Offer Summary: $" + total.toFixed(2);
    }

    loadData();
  </script>
</body>
</html>