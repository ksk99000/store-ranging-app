<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Store Ranging App - iOS 26 Theme</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text",Arial,sans-serif;padding:20px;background:linear-gradient(135deg,#fdfdfd,#f5f9ff);color:#1c1c1e}
    h1{font-size:24px;font-weight:700;margin-bottom:12px;color:#007aff}
    button,select{padding:10px 14px;margin:6px 4px 6px 0;border-radius:12px;border:none;font-size:15px;font-weight:500;cursor:pointer;transition:all .2s}
    button{background:#007aff;color:#fff}
    button:hover{background:#0063cc}
    select{background:#fff;border:1px solid #ccc}

    .card{border-radius:16px;margin:10px 0;padding:14px;display:flex;align-items:center;gap:12px;backdrop-filter:blur(20px);box-shadow:0 4px 8px rgba(0,0,0,.06);cursor:pointer;transition:transform .2s,box-shadow .2s;background:rgba(255,255,255,.9)}
    .card:hover{transform:translateY(-2px);box-shadow:0 6px 14px rgba(0,0,0,.1)}
    .card img{width:70px;height:70px;object-fit:contain;border-radius:12px;background:#f2f2f7;flex-shrink:0}
    .card.not-ranging{background:#ffecec}
    .card.not-buying{background:#fff4e5}
    .card.ranging{background:#ecffec}

    .add{background:#007aff;color:#fff}
    .add.added{background:#34c759}
    .not{background:#ff3b30;color:#fff}
    .restore{background:#ff9500;color:#fff}

    .summary{background:rgba(255,255,255,.95);backdrop-filter:blur(20px);border-radius:16px;padding:16px;box-shadow:0 4px 8px rgba(0,0,0,.06);margin:15px 0;display:none;border-left:5px solid #007aff}

    .toggle-group{display:flex;background:#e5e5ea;border-radius:10px;padding:2px;width:fit-content;margin:10px 0}
    .toggle-btn{flex:1;padding:8px 14px;border:none;border-radius:8px;background:transparent;color:#007aff;font-weight:600;cursor:pointer;transition:all .2s}
    .toggle-btn.active{background:#fff;color:#007aff;box-shadow:0 1px 4px rgba(0,0,0,.1)}

    #storeModal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.35);align-items:flex-end;justify-content:center}
    #storeModalContent{background:#fff;width:100%;max-height:60%;border-top-left-radius:20px;border-top-right-radius:20px;padding:20px;overflow:auto;animation:slideUp .25s ease;box-shadow:0 -2px 10px rgba(0,0,0,.15)}
    @keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}

    #debug{background:#fff;border-radius:12px;padding:12px;font-size:12px;margin-top:20px;box-shadow:inset 0 1px 3px rgba(0,0,0,.08);white-space:pre-wrap}

    .pill-red{background:#ff3b30}.pill-orange{background:#ff9500}.pill-green{background:#34c759}
  </style>
</head>
<body>
  <h1>ðŸ“± Store Ranging App</h1>
  <button onclick="loadData()">ðŸ”„ Refresh</button>
  <button id="viewToggleSwitch" onclick="toggleView()">ðŸ“Š Switch to Store View</button>

  <div id="storeControls" style="display:none;">
    <label for="storeSelect">Select a store:</label>
    <select id="storeSelect" onchange="renderProducts()">
      <option value="">-- Choose a store --</option>
    </select>

    <div class="toggle-group" id="viewToggle">
      <button class="toggle-btn active" id="btnNotRanging" onclick="setView('not ranging')">ðŸ”´ Not Ranging</button>
      <button class="toggle-btn" id="btnRanging" onclick="setView('ranging')">ðŸŸ¢ Ranging</button>
    </div>

    <div id="summary" class="summary">
      <strong>Total Deal Offer Summary:</strong> $<span id="total">0.00</span>
      <ul id="offerList"></ul>
    </div>
  </div>

  <div id="products"></div>

  <div id="dashboard" style="display:none;margin-top:20px;">
    <h2 style="color:#007aff;">ðŸ“Š Product Dashboard</h2>
    <div id="dashboardContent"></div>
  </div>

  <div id="storeModal">
    <div id="storeModalContent">
      <h3 id="modalTitle" style="color:#007aff;">Stores Not Ranging</h3>
      <ul id="storeList"></ul>
    </div>
  </div>

  <div>
    <h3 style="color:#007aff;">ðŸ›  Debug Output</h3>
    <div id="debug">Waiting for data...</div>
  </div>

  <script>
    const scriptUrl = "https://script.google.com/macros/s/AKfycbwjs8iFcXbkXPcYbcvqAgKtU2grsMuxcoOOVY8Aox3nXppahHuktklIf7snHC86yN907Q/exec";
    let allData = [];
    let selectedDeals = {};
    let currentView = "not ranging";
    let currentMode = "dashboard";

    function normalizeStatus(raw) {
      const s = String(raw ?? "").trim().toLowerCase();
      if (["ranging","ranged","yes","buying"].includes(s)) return "ranging";
      if (s.includes("not buying")) return "not buying";
      if (s.includes("not")) return "not ranging";
      return "unknown";
    }

    async function loadData() {
      try {
        setDebug("Loading data...");
        const resp = await fetch(scriptUrl, { cache: "no-store" });
        const json = await resp.json();
        allData = json;
        setDebug("Loaded " + allData.length + " rows");
        populateStores();
        resetSummary();
        showDashboard();
      } catch (err) {
        setDebug("Error: " + err);
      }
    }

    function setDebug(msg) { document.getElementById("debug").textContent = msg; }

    function populateStores() {
      const select = document.getElementById("storeSelect");
      select.innerHTML = '<option value="">-- Choose a store --</option>';
      const stores = [...new Set(allData.map(d => d.Store))].filter(Boolean).sort();
      stores.forEach(s => {
        const opt = document.createElement("option");
        opt.value = s; opt.textContent = s;
        select.appendChild(opt);
      });
    }

    function resetSummary() { selectedDeals = {}; updateSummary(); }

    function setView(view) {
      currentView = view;
      document.getElementById("btnNotRanging").classList.toggle("active", view === "not ranging");
      document.getElementById("btnRanging").classList.toggle("active", view === "ranging");
      renderProducts();
    }

    function renderProducts() {
      document.getElementById("dashboard").style.display = "none";
      document.getElementById("storeControls").style.display = "block";
      const container = document.getElementById("products");
      container.innerHTML = "";
      const storeName = document.getElementById("storeSelect").value;
      if (!storeName) return;

      const filtered = allData.filter(item => {
        if (item.Store !== storeName) return false;
        const st = normalizeStatus(item.Status);
        if (currentView === "not ranging") return st === "not ranging";
        if (currentView === "ranging") return st === "ranging" || st === "not buying";
      });

      if (filtered.length === 0) { container.textContent = "No products found."; return; }

      filtered.forEach(p => {
        const st = normalizeStatus(p.Status);
        const card = document.createElement("div");
        card.className = "card " + (st === "not ranging" ? "not-ranging" : st === "not buying" ? "not-buying" : st === "ranging" ? "ranging" : "");

        const img = document.createElement("img");
        img.src = p["Image URL"] || "";
        img.alt = p.Product || "Product";

        const nameEl = document.createElement("strong");
        nameEl.textContent = p.Product || "-";

        const btnDiv = document.createElement("div");
        const btnAdd = document.createElement("button");
        btnAdd.className = "add";
        btnAdd.textContent = "Add to Offer";
        btnAdd.onclick = e => { e.stopPropagation(); toggleOffer(btnAdd, p); };
        const btnNot = document.createElement("button");
        btnNot.className = "not";
        btnNot.textContent = "Not Buying";
        btnNot.onclick = e => { e.stopPropagation(); updateStatus(p, "Not Buying"); };
        btnDiv.appendChild(btnAdd);
        btnDiv.appendChild(btnNot);

        card.appendChild(img);
        card.appendChild(nameEl);
        card.appendChild(btnDiv);
        container.appendChild(card);
      });
    }

    function toggleOffer(btn, productObj) {
      const name = productObj["Product"];
      const deal = parseFloat(productObj["50% Deal"]) || 0;
      if (btn.classList.contains("added")) {
        delete selectedDeals[name];
        btn.classList.remove("added"); btn.textContent = "Add to Offer";
      } else {
        selectedDeals[name] = deal;
        btn.classList.add("added"); btn.textContent = "Added";
      }
      updateSummary();
    }

    function updateSummary() {
      const total = Object.values(selectedDeals).reduce((a,b)=>a+b,0);
      document.getElementById("total").textContent = total.toFixed(2);
      const list = document.getElementById("offerList"); list.innerHTML = "";
      Object.entries(selectedDeals).forEach(([n,v]) => {
        const li = document.createElement("li"); li.textContent = `${n} - $${v.toFixed(2)}`;
        list.appendChild(li);
      });
    }

    function updateStatus(productObj, newStatus) {
      fetch(scriptUrl, {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({ Store: productObj.Store, Product: productObj.Product, Status: newStatus })
      }).then(r=>r.text()).then(()=>loadData());
    }

    function showDashboard() {
      currentMode = "dashboard";
      document.getElementById("dashboard").style.display = "block";
      document.getElementById("products").innerHTML = "";
      renderDashboard();
    }

    function renderDashboard() {
      const container = document.getElementById("dashboardContent"); container.innerHTML = "";
      const grouped = {};
      allData.forEach(item => {
        const prod = item.Product; if (!prod) return;
        const st = normalizeStatus(item.Status);
        if (!grouped[prod]) grouped[prod] = { product:item, ranging:0, notRanging:0, notBuying:0 };
        if (st === "ranging") grouped[prod].ranging++;
        else if (st === "not ranging") grouped[prod].notRanging++;
        else if (st === "not buying") grouped[prod].notBuying++;
      });

      Object.values(grouped).forEach(g => {
        const card = document.createElement("div"); card.className = "card";
        const img = document.createElement("img"); img.src = g.product["Image URL"] || "";
        const nameEl = document.createElement("strong"); nameEl.textContent = g.product.Product || "-";

        const pill = document.createElement("div");
        pill.style.display="flex"; pill.style.borderRadius="20px"; pill.style.overflow="hidden"; pill.style.width="300px"; pill.style.height="20px";
        const total = g.ranging+g.notRanging+g.notBuying||1;
        const seg=(c,cls)=>{const d=document.createElement("div"); d.style.width=(c/total*100)+"%"; d.className=cls; d.title=c; return d;};
        pill.appendChild(seg(g.notRanging,"pill-red"));
        pill.appendChild(seg(g.notBuying,"pill-orange"));
        pill.appendChild(seg(g.ranging,"pill-green"));

        const counts=document.createElement("div");
        counts.textContent=`ðŸ”´ ${g.notRanging}   ðŸŸ  ${g.notBuying}   ðŸŸ¢ ${g.ranging}`;

        card.appendChild(img);
        card.appendChild(nameEl);
        card.appendChild(pill);
        card.appendChild(counts);
        card.addEventListener("click",()=>showStoreModal(g.product.Product));
        container.appendChild(card);
      });
    }

    function toggleView() {
      if (currentMode === "dashboard") {
        currentMode = "store";
        document.getElementById("dashboard").style.display="none";
        document.getElementById("storeControls").style.display="block";
        document.getElementById("viewToggleSwitch").textContent="ðŸ  Switch to Dashboard";
        renderProducts();
      } else {
        showDashboard();
        document.getElementById("storeControls").style.display="none";
        document.getElementById("viewToggleSwitch").textContent="ðŸ“Š Switch to Store View";
      }
    }

    function showStoreModal(productName) {
      const modal=document.getElementById("storeModal");
      const title=document.getElementById("modalTitle");
      const list=document.getElementById("storeList");
      title.textContent=`Stores Not Ranging: ${productName}`;
      list.innerHTML="";
      const stores=allData.filter(i=>i.Product===productName && normalizeStatus(i.Status)==="not ranging").map(i=>i.Store);
      if (stores.length===0){const li=document.createElement("li");li.textContent="No stores found.";list.appendChild(li);} 
      else {stores.forEach(s=>{const li=document.createElement("li");li.textContent=s;list.appendChild(li);});}
      modal.style.display="flex";
    }

    document.getElementById("storeModal").addEventListener("click",e=>{if(e.target===e.currentTarget)e.currentTarget.style.display="none";});
    loadData();
  </script>
</body>
</html>