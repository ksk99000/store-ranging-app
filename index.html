<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Store Ranging & Deals App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar for a cleaner look on desktops */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        ::-webkit-scrollbar-thumb {
            background: #94a3b8;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
        .active-store {
            background-color: #2563eb; /* blue-600 */
            color: white;
        }
        /* Simple loading spinner */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Styling for the deal button */
        .add-deal-button.selected {
            background-color: #16a34a; /* green-600 */
            color: white;
            font-weight: bold;
        }
        /* Styling for view switcher */
        .view-button.active-view {
            background-color: #2563eb; /* blue-600 */
            color: white;
            font-weight: 600;
        }
        /* Ensure tooltip is above everything */
        #product-info-tooltip {
            z-index: 50;
        }
        #store-list-dropdown {
            z-index: 40;
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">

    <div class="h-screen flex flex-col">
        <main class="w-full flex-grow flex flex-col bg-slate-50">
            <header class="p-4 border-b border-slate-200 bg-white relative">
                <div class="mb-4">
                    <div class="inline-flex rounded-md shadow-sm" role="group">
                        <button type="button" id="dashboard-view-btn" class="view-button active-view px-4 py-2 text-sm font-medium text-slate-900 bg-white border border-slate-200 rounded-l-lg hover:bg-slate-100">
                            Product Dashboard
                        </button>
                        <button type="button" id="store-view-btn" class="view-button px-4 py-2 text-sm font-medium text-slate-900 bg-white border-t border-b border-slate-200 hover:bg-slate-100">
                            Store Ranging
                        </button>
                        <button type="button" id="calendar-view-btn" class="view-button px-4 py-2 text-sm font-medium text-slate-900 bg-white border-t border-b border-r border-slate-200 hover:bg-slate-100 rounded-r-md">
                            Store Visit Calendar
                        </button>
                    </div>
                </div>

                <div id="store-selector-container">
                    <div id="store-selector-button" class="inline-block cursor-pointer p-2 -m-2 rounded-md hover:bg-slate-100">
                         <h2 id="results-header" class="text-xl font-bold text-slate-900">Select a Store</h2>
                         <p id="results-subheader" class="text-sm text-slate-500">Tap to choose a store from the list</p>
                    </div>
                </div>


                <div id="store-list-dropdown" class="hidden absolute top-full left-4 mt-1 w-80 max-h-96 bg-white rounded-lg shadow-xl border border-slate-200 flex flex-col">
                    <div class="p-2 border-b border-slate-200">
                        <input type="text" id="store-search-input" placeholder="Type to search for a store..." class="w-full px-3 py-2 text-sm border border-slate-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div id="store-loader" class="text-center p-8">
                        <div class="loader mx-auto"></div>
                        <p class="mt-2 text-slate-500">Loading stores...</p>
                    </div>
                    <ul id="store-ul-list" class="flex-grow overflow-y-auto">
                    </ul>
                </div>
            </header>

            <div class="flex-grow p-4 overflow-y-auto">

                <div id="dashboard-view">
                    <div id="dashboard-loader" class="text-center p-8">
                        <div class="loader mx-auto"></div>
                        <p class="mt-2 text-slate-500">Calculating product stats...</p>
                    </div>
                    
                    <div id="dashboard-summary" class="flex flex-wrap gap-4 mb-6">
                        </div>

                    <div id="product-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4">
                        </div>
                </div>

                <div id="store-view" class="hidden">
                    <div id="deal-offer-box" class="mb-4 p-4 bg-blue-100 border border-blue-200 rounded-lg hidden">
                        <h3 class="font-bold text-lg text-blue-800">Total Deal Offer Summary</h3>
                        <p class="text-sm text-blue-600">Based on 50% Deal Price</p>
                        <p id="deal-total" class="text-3xl font-bold text-blue-900 mt-1">$0.00</p>
                        <ul id="deal-list" class="mt-2 text-sm list-disc list-inside text-slate-700 space-y-1"></ul>
                    </div>

                     <div id="results-table-container" class="w-full">
                        <table class="min-w-full bg-white rounded-lg shadow">
                            <thead class="bg-slate-200">
                                <tr>
                                    <th class="p-3 text-left text-sm font-semibold text-slate-600 tracking-wider w-20">Image</th>
                                    <th class="p-3 text-left text-sm font-semibold text-slate-600 tracking-wider">Product</th>
                                    <th class="p-3 text-left text-sm font-semibold text-slate-600 tracking-wider">Metcash Code</th>
                                    <th class="p-3 text-left text-sm font-semibold text-slate-600 tracking-wider">50% Deal</th>
                                    <th class="p-3 text-center text-sm font-semibold text-slate-600 tracking-wider">Add to Offer</th>
                                </tr>
                            </thead>
                            <tbody id="results-body">
                                <tr id="results-placeholder">
                                    <td colspan="5" class="p-8 text-center text-slate-500">
                                        Loading data from your Google Sheet...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div id="calendar-view" class="hidden text-center p-8">
                    <h2 class="text-2xl font-bold text-slate-700">Coming Soon!</h2>
                    <p class="text-slate-500 mt-2">The Store Visit Calendar feature is under construction.</p>
                </div>
            </div>
        </main>
    </div>

    <div id="product-info-tooltip" class="hidden fixed p-4 bg-white rounded-lg shadow-2xl border border-slate-300 max-w-xs w-full">
        <div class="flex justify-between items-center pb-2 border-b border-slate-200 mb-2">
            <h4 id="tooltip-product-name" class="font-bold text-base text-slate-800">Product Details</h4>
            <button id="tooltip-close-btn" class="text-2xl font-bold text-slate-400 hover:text-slate-800 leading-none">&times;</button>
        </div>
        <div id="tooltip-content" class="space-y-2 text-sm">
            </div>
    </div>

    <!-- Modal for showing stores not ranging -->
    <div id="not-ranging-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full max-h-[80vh] flex flex-col">
            <div class="p-4 border-b flex justify-between items-center">
                <h3 id="modal-product-name" class="text-lg font-bold text-slate-800">Stores Not Ranging</h3>
                <button id="modal-close-btn-x" class="text-2xl font-bold text-slate-400 hover:text-slate-800 leading-none">&times;</button>
            </div>
            <div id="modal-store-list" class="p-4 overflow-y-auto">
                <!-- Store list will be populated by JS -->
            </div>
             <div class="p-3 bg-slate-50 border-t text-right">
                <button id="modal-close-btn" class="px-4 py-2 text-sm bg-slate-500 text-white rounded-md hover:bg-slate-600">Close</button>
            </div>
        </div>
    </div>


    <script>
        // --- RELIABLE DATA SOURCE FROM GOOGLE APPS SCRIPT ---
        const webAppUrl = 'https://script.google.com/macros/s/AKfycbxrP1ADOum-wxuaM4AwBzbGHKbG_3KJOLJNfeCcixt_3AjrXgfIJ7Ncp8uekeidG8I9_g/exec';

        // State management for selected deals
        let selectedDeals = [];

        document.addEventListener('DOMContentLoaded', () => {
            // View containers and buttons
            const dashboardView = document.getElementById('dashboard-view');
            const storeView = document.getElementById('store-view');
            const calendarView = document.getElementById('calendar-view');
            const dashboardBtn = document.getElementById('dashboard-view-btn');
            const storeBtn = document.getElementById('store-view-btn');
            const calendarBtn = document.getElementById('calendar-view-btn');
            const storeSelectorContainer = document.getElementById('store-selector-container');

            // Store view elements
            const storeListDropdown = document.getElementById('store-list-dropdown');
            const storeUlList = document.getElementById('store-ul-list');
            const storeSearchInput = document.getElementById('store-search-input');
            const resultsHeader = document.getElementById('results-header');
            const resultsSubheader = document.getElementById('results-subheader');
            const resultsBody = document.getElementById('results-body');
            const storeLoader = document.getElementById('store-loader');
            const resultsPlaceholder = document.getElementById('results-placeholder');
            const dealOfferBox = document.getElementById('deal-offer-box');
            const storeSelectorButton = document.getElementById('store-selector-button');

            // Tooltip elements
            const tooltip = document.getElementById('product-info-tooltip');
            const tooltipCloseBtn = document.getElementById('tooltip-close-btn');

            // Modal elements
            const modal = document.getElementById('not-ranging-modal');
            const modalCloseBtn = document.getElementById('modal-close-btn');
            const modalCloseBtnX = document.getElementById('modal-close-btn-x');

            // --- View Switching Logic ---
            dashboardBtn.addEventListener('click', () => {
                storeView.classList.add('hidden');
                dashboardView.classList.remove('hidden');
                calendarView.classList.add('hidden');
                storeSelectorContainer.classList.add('hidden');
                dashboardBtn.classList.add('active-view');
                storeBtn.classList.remove('active-view');
                calendarBtn.classList.remove('active-view');
            });
             storeBtn.addEventListener('click', () => {
                dashboardView.classList.add('hidden');
                storeView.classList.remove('hidden');
                calendarView.classList.add('hidden');
                storeSelectorContainer.classList.remove('hidden');
                storeBtn.classList.add('active-view');
                dashboardBtn.classList.remove('active-view');
                calendarBtn.classList.remove('active-view');
            });
             calendarBtn.addEventListener('click', () => {
                storeView.classList.add('hidden');
                dashboardView.classList.add('hidden');
                calendarView.classList.remove('hidden');
                storeSelectorContainer.classList.add('hidden');
                calendarBtn.classList.add('active-view');
                dashboardBtn.classList.remove('active-view');
                storeBtn.classList.remove('active-view');
            });
            // Set initial view state
            storeSelectorContainer.classList.add('hidden');

            
            // --- Data Fetching and Initialization ---
            fetch(webAppUrl)
                .then(response => response.json())
                .then(data => {
                    if (data.error || !data.rangingData || !data.dealsData) {
                        document.getElementById('dashboard-loader').innerHTML = `<p class="text-red-600 font-semibold text-center">Error loading data:<br>${data.error || 'Unknown error'}</p>`;
                        resultsPlaceholder.querySelector('td').textContent = 'Error loading data.';
                        return;
                    }
                    storeLoader.style.display = 'none';
                    resultsPlaceholder.querySelector('td').textContent = 'Please select a store from the list.';
                    
                    const rangingData = data.rangingData.map(row => ({ store: row[0], product: row[1], status: row[2] }));
                    const dealsData = data.dealsData;
                    
                    const dealsMap = new Map();
                    dealsData.forEach(deal => {
                        if (deal.product) {
                           dealsMap.set(deal.product, deal);
                        }
                    });

                    // Initialize both parts of the app
                    initializeStoreView(rangingData, dealsMap);
                    initializeDashboardView(rangingData, dealsMap);
                })
                .catch(error => {
                    console.error("Fetch failed:", error);
                     document.getElementById('dashboard-loader').innerHTML = '<p class="text-red-600 font-semibold text-center">Could not connect to data source.<br>Please check your internet connection.</p>';
                });

            // ===================================================
            // Dashboard View Functions
            // ===================================================
            function initializeDashboardView(rangingData, dealsMap) {
                const productStats = {};
                let totalNotRangingInstances = 0;
                let totalRangingInstances = 0;
                
                rangingData.forEach(item => {
                    if (!item.product) return;
                    if (!productStats[item.product]) {
                        productStats[item.product] = { ranging: 0, notRanging: 0 };
                    }
                    if (item.status && item.status.toLowerCase() === 'not ranging') {
                        productStats[item.product].notRanging++;
                        totalNotRangingInstances++;
                    } else {
                        productStats[item.product].ranging++;
                        totalRangingInstances++;
                    }
                });

                displayDashboardSummary({ totalNotRangingInstances, totalRangingInstances });
                displayDashboard(productStats, dealsMap, rangingData);
            }

            function displayDashboardSummary(summary) {
                const container = document.getElementById('dashboard-summary');
                const totalInstances = summary.totalRangingInstances + summary.totalNotRangingInstances;
                const rangingPercent = totalInstances > 0 ? (summary.totalRangingInstances / totalInstances) * 100 : 0;
                const notRangingPercent = totalInstances > 0 ? (summary.totalNotRangingInstances / totalInstances) * 100 : 0;

                container.innerHTML = `
                    <div class="w-full bg-white p-4 rounded-lg shadow">
                        <h3 class="text-base font-medium text-slate-600 mb-2 text-center">Overall Ranging Status</h3>
                        <div class="flex w-full h-10 text-white text-lg font-bold rounded-full overflow-hidden bg-slate-200" title="Total Ranging vs. Not Ranging Instances Across All Stores">
                            <div class="bg-green-500 flex items-center justify-center transition-all duration-500" style="width: ${rangingPercent}%">
                                <span>${summary.totalRangingInstances}</span>
                            </div>
                            <div class="bg-red-500 flex items-center justify-center transition-all duration-500" style="width: ${notRangingPercent}%">
                                <span>${summary.totalNotRangingInstances}</span>
                            </div>
                        </div>
                        <div class="flex justify-between text-sm text-slate-500 mt-2 px-1">
                            <div class="flex items-center">
                                <span class="w-3 h-3 rounded-full bg-green-500 mr-2"></span>
                                <span>Ranging</span>
                            </div>
                            <div class="flex items-center">
                                <span class="w-3 h-3 rounded-full bg-red-500 mr-2"></span>
                                <span>Not Ranging</span>
                            </div>
                        </div>
                    </div>
                `;
            }

            function displayDashboard(productStats, dealsMap, rangingData) {
                const grid = document.getElementById('product-grid');
                grid.innerHTML = '';
                document.getElementById('dashboard-loader').style.display = 'none';

                for (const productName in productStats) {
                    const stats = productStats[productName];

                    // Only display products that have at least one "Not Ranging" instance.
                    if (stats.notRanging === 0) continue;

                    const dealInfo = dealsMap.get(productName) || {};
                    const total = stats.ranging + stats.notRanging;
                    if (total === 0) continue;

                    const rangingPercent = (stats.ranging / total) * 100;
                    const notRangingPercent = (stats.notRanging / total) * 100;
                    
                    const imageUrl = dealInfo.imageurl || '';
                    const placeholderUrl = `https://placehold.co/150x150/e2e8f0/64748b?text=No+Img`;

                    const card = document.createElement('div');
                    card.className = 'bg-white rounded-lg shadow p-3 flex flex-col';
                    card.innerHTML = `
                        <img src="${imageUrl || placeholderUrl}" alt="${productName}" class="w-full h-32 object-cover rounded-md mb-2 cursor-pointer" loading="lazy" onerror="this.onerror=null;this.src='${placeholderUrl}';" data-product-name="${productName}">
                        <h3 class="font-semibold text-sm text-slate-800 flex-grow">${productName}</h3>
                        <div class="mt-2">
                            <p class="text-xs text-slate-500 mb-1">Ranging Status (${total} Stores)</p>
                            <div class="flex w-full h-6 text-white text-xs font-bold rounded-md overflow-hidden bg-slate-200">
                                <div class="bg-green-500 flex items-center justify-center" style="width: ${rangingPercent}%" title="${stats.ranging} Ranging">
                                    ${stats.ranging > 0 ? stats.ranging : ''}
                                </div>
                                <div class="bg-red-500 flex items-center justify-center" style="width: ${notRangingPercent}%" title="${stats.notRanging} Not Ranging">
                                    ${stats.notRanging > 0 ? stats.notRanging : ''}
                                </div>
                            </div>
                        </div>
                    `;
                    grid.appendChild(card);

                    // Add click listener to the image for this card
                    card.querySelector('img').addEventListener('click', (event) => {
                        const clickedProductName = event.target.dataset.productName;
                        showNotRangingStoresModal(clickedProductName, rangingData);
                    });
                }
            }
            
            function showNotRangingStoresModal(productName, rangingData) {
                const modalProductName = document.getElementById('modal-product-name');
                const modalStoreList = document.getElementById('modal-store-list');

                modalProductName.textContent = `Stores Not Ranging: ${productName}`;

                const notRangingStores = rangingData
                    .filter(item => item.product === productName && item.status && item.status.toLowerCase() === 'not ranging')
                    .map(item => item.store)
                    .sort();

                if (notRangingStores.length > 0) {
                    modalStoreList.innerHTML = `
                        <ul class="list-disc list-inside space-y-2 text-slate-700">
                            ${notRangingStores.map(store => `<li>${store}</li>`).join('')}
                        </ul>
                    `;
                } else {
                    modalStoreList.innerHTML = '<p class="text-slate-500">This product is ranged in all applicable stores.</p>';
                }

                modal.classList.remove('hidden');
            }


            // ===================================================
            // Store View Functions
            // ===================================================
            function initializeStoreView(rangingData, dealsMap) {
                const stores = [...new Set(rangingData.map(item => item.store))].filter(Boolean).sort();

                storeSelectorButton.addEventListener('click', (event) => {
                    event.stopPropagation(); // Prevents the document click listener from firing
                    if (storeLoader.style.display === 'none') {
                        storeListDropdown.classList.toggle('hidden');
                        storeSearchInput.focus();
                    }
                });

                storeSearchInput.addEventListener('input', () => {
                    const searchTerm = storeSearchInput.value.toLowerCase();
                    const storeItems = storeUlList.querySelectorAll('li');
                    let visibleCount = 0;
                    storeItems.forEach(item => {
                        const storeName = item.textContent.toLowerCase();
                        if (storeName.includes(searchTerm)) {
                            item.style.display = '';
                            visibleCount++;
                        } else {
                            item.style.display = 'none';
                        }
                    });
                });
                
                storeSearchInput.addEventListener('click', (e) => e.stopPropagation());

                stores.forEach(store => {
                    const li = document.createElement('li');
                    li.textContent = store;
                    li.className = 'p-3 cursor-pointer hover:bg-slate-100 transition-colors duration-150 border-b border-slate-200 truncate';
                    li.addEventListener('click', () => {
                        document.querySelectorAll('#store-ul-list li').forEach(el => el.classList.remove('active-store'));
                        li.classList.add('active-store');
                        tooltip.classList.add('hidden');
                        
                        storeListDropdown.classList.add('hidden');
                        resultsHeader.textContent = store;
                        resultsSubheader.textContent = "Tap name to change store";
                        storeSearchInput.value = ''; // Reset search field
                        storeUlList.querySelectorAll('li').forEach(item => item.style.display = ''); // Reset list view

                        displayStoreData(store, rangingData, dealsMap);
                    });
                    storeUlList.appendChild(li);
                });
            }

            function displayStoreData(storeName, rangingData, dealsMap) {
                selectedDeals = [];
                updateTotalDealOffer();
                
                const notRangingProducts = rangingData.filter(item =>
                    item.store === storeName &&
                    item.status &&
                    item.status.toLowerCase() === 'not ranging'
                );
                
                resultsBody.innerHTML = '';

                if (notRangingProducts.length === 0) {
                    resultsBody.innerHTML = `<tr><td colspan="5" class="p-8 text-center text-slate-500">This store ranges all products.</td></tr>`;
                    dealOfferBox.classList.add('hidden');
                    return;
                }
                
                dealOfferBox.classList.remove('hidden');

                notRangingProducts.forEach(rangingItem => {
                    const productName = rangingItem.product;
                    const deal = dealsMap.get(productName);
                    
                    const tr = document.createElement('tr');
                    tr.className = 'border-b border-slate-200 cursor-pointer hover:bg-slate-50';

                    const metcashCode = deal ? deal.metcashcode : 'Info Not Found';
                    const fiftyPercentDeal = deal ? deal['50deal'] : 'N/A';
                    const imageUrl = deal ? deal.imageurl : '';
                    const placeholderUrl = `https://placehold.co/60x60/e2e8f0/64748b?text=No+Img`;

                    tr.innerHTML = `
                        <td class="p-2">
                           <img src="${imageUrl || placeholderUrl}" alt="${productName}" class="w-12 h-12 object-cover rounded-md" loading="lazy" onerror="this.onerror=null;this.src='${placeholderUrl}';">
                        </td>
                        <td class="p-3 font-medium text-slate-800">${productName}</td>
                        <td class="p-3 text-slate-600">${metcashCode}</td>
                        <td class="p-3 text-slate-600">${fiftyPercentDeal}</td>
                        <td class="p-3 text-center">
                            <div class="flex justify-center items-center gap-2">
                                <button class="add-deal-button px-3 py-1 text-sm bg-blue-500 text-white rounded-md hover:bg-blue-600 transition-colors" data-product-name="${productName}" data-deal-price="${fiftyPercentDeal}">
                                    Add to Deal
                                </button>
                                <button class="not-buying-button px-3 py-1 text-sm bg-slate-400 text-white rounded-md hover:bg-slate-500 transition-colors" data-product-name="${productName}">
                                    Not Buying
                                </button>
                            </div>
                        </td>
                    `;
                    resultsBody.appendChild(tr);

                    tr.addEventListener('click', (event) => {
                        if (event.target.tagName.toLowerCase() === 'button') return;
                        showProductInfo(deal, productName, event);
                    });
                });

                resultsBody.querySelectorAll('.add-deal-button').forEach(button => {
                    button.addEventListener('click', handleDealButtonClick);
                });

                resultsBody.querySelectorAll('.not-buying-button').forEach(button => {
                    button.addEventListener('click', handleNotBuyingClick);
                });
            }

            function handleDealButtonClick(event) {
                event.stopPropagation();
                const button = event.target;
                const productName = button.dataset.productName;
                const dealPrice = button.dataset.dealPrice;
                const existingDealIndex = selectedDeals.findIndex(d => d.productName === productName);

                if (existingDealIndex > -1) {
                    selectedDeals.splice(existingDealIndex, 1);
                    button.classList.remove('selected');
                    button.textContent = 'Add to Deal';
                } else {
                    if (dealPrice && dealPrice !== 'N/A' && dealPrice !== 'undefined') {
                        selectedDeals.push({ productName, dealPrice });
                        button.classList.add('selected');
                        button.textContent = 'Added';
                    }
                }
                updateTotalDealOffer();
            }

            function handleNotBuyingClick(event) {
                event.stopPropagation();
                const button = event.target;
                const row = button.closest('tr');
                const productName = button.dataset.productName;

                // Remove from selected deals if it was added before
                const existingDealIndex = selectedDeals.findIndex(d => d.productName === productName);
                if (existingDealIndex > -1) {
                    selectedDeals.splice(existingDealIndex, 1);
                    updateTotalDealOffer();
                }

                // Remove the entire row from the table
                row.remove();
            }

            function updateTotalDealOffer() {
                const dealTotalEl = document.getElementById('deal-total');
                const dealListEl = document.getElementById('deal-list');
                
                if (selectedDeals.length === 0) {
                    dealTotalEl.textContent = '$0.00';
                    dealListEl.innerHTML = '<li>No deals selected yet.</li>';
                    return;
                }

                let total = 0;
                dealListEl.innerHTML = '';

                selectedDeals.forEach(deal => {
                    const priceText = deal.dealPrice || '0';
                    const price = parseFloat(priceText.replace(/[^0-9.-]+/g, ""));
                    if (!isNaN(price)) total += price;
                    const li = document.createElement('li');
                    li.textContent = `${deal.productName} (@ ${priceText})`;
                    dealListEl.appendChild(li);
                });
                
                dealTotalEl.textContent = `$${total.toFixed(2)}`;
            }

            function showProductInfo(deal, productName, event) {
                const tooltipProductName = document.getElementById('tooltip-product-name');
                const tooltipContent = document.getElementById('tooltip-content');

                tooltipProductName.textContent = productName;

                if (!deal) {
                    tooltipContent.innerHTML = '<p class="text-slate-500">This product does not have a matching entry in the Deals sheet.</p>';
                } else {
                    tooltipContent.innerHTML = `
                        <p><strong class="font-semibold text-slate-600 w-32 inline-block">Case Cost:</strong> <span class="text-slate-800">${deal.listprice || 'N/A'}</span></p>
                        <p><strong class="font-semibold text-slate-600 w-32 inline-block">SDA Ranking:</strong> <span class="text-slate-800">${deal.sdaranking || 'N/A'}</span></p>
                        <p><strong class="font-semibold text-slate-600 w-32 inline-block">Category:</strong> <span class="text-slate-800">${deal.category || 'N/A'}</span></p>
                        <p><strong class="font-semibold text-slate-600 w-32 inline-block">Metcash Grade:</strong> <span class="text-slate-800">${deal.metcashgrade || 'N/A'}</span></p>
                        <p><strong class="font-semibold text-slate-600 w-32 inline-block">Metcash Layout:</strong> <span class="text-slate-800">${deal.metcashlayout || 'N/A'}</span></p>
                        <p><strong class="font-semibold text-slate-600 w-32 inline-block">Base Range:</strong> <span class="text-slate-800">${deal.metcashbaserange || 'N/A'}</span></p>
                    `;
                }

                let top = event.pageY + 10;
                let left = event.pageX + 10;
                if (left + tooltip.offsetWidth > window.innerWidth) {
                    left = event.pageX - tooltip.offsetWidth - 10;
                }
                if (top + tooltip.offsetHeight > window.innerHeight) {
                    top = event.pageY - tooltip.offsetHeight - 10;
                }

                tooltip.style.top = `${top}px`;
                tooltip.style.left = `${left}px`;
                tooltip.classList.remove('hidden');
            }

            // --- Modal Closing Logic ---
            function hideModal() {
                modal.classList.add('hidden');
            }
            modalCloseBtn.addEventListener('click', hideModal);
            modalCloseBtnX.addEventListener('click', hideModal);
            modal.addEventListener('click', (event) => {
                // If the click is on the dark background overlay itself, close the modal.
                if (event.target === modal) {
                    hideModal();
                }
            });


            tooltipCloseBtn.addEventListener('click', () => {
                tooltip.classList.add('hidden');
            });

            document.addEventListener('click', (event) => {
                const isButtonClick = event.target.closest('#store-selector-button');
                const isDropdownContent = event.target.closest('#store-list-dropdown');
                const isTooltipClick = event.target.closest('#product-info-tooltip');
                const isRowClick = event.target.closest('tbody tr');

                if (!isButtonClick && !isDropdownContent && !storeListDropdown.classList.contains('hidden')) {
                    storeListDropdown.classList.add('hidden');
                }
                if (!isRowClick && !isTooltipClick) {
                    tooltip.classList.add('hidden');
                }
            });

        });
    </script>
</body>
</html>


