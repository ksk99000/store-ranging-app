<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Store Ranging App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    h1 { font-size: 24px; }
    select, button { padding: 8px; margin: 5px 0; }
    .summary { background: #eef; padding: 10px; border: 1px solid #ccd; margin-bottom: 15px; display: none; }
    .card { border: 1px solid #ccc; border-radius: 8px; margin: 10px 0; padding: 10px; display: flex; align-items: center; cursor:pointer; }
    .card img { width: 80px; height: 80px; object-fit: contain; margin-right: 15px; background: #f8f8f8; }
    .main-line { display: flex; align-items: center; justify-content: space-between; flex: 1; }
    .buttons { margin-left: auto; }
    .add { background: blue; color: white; padding: 6px 10px; border: none; border-radius: 4px; cursor: pointer; }
    .add.added { background: green; }
    .not { background: red; color: white; padding: 6px 10px; border: none; border-radius: 4px; cursor: pointer; margin-left: 5px; }
    .restore { background: orange; color: white; padding: 6px 10px; border: none; border-radius: 4px; cursor: pointer; margin-left: 5px; }
    .details { display: none; flex-direction: column; margin-top: 10px; }
    #products { margin-top: 20px; }
    #offerList { margin-top: 10px; padding-left: 20px; }
    #debug { white-space: pre-wrap; background: #fafafa; border: 1px solid #ddd; padding: 10px; margin-top: 20px; font-size: 12px; }
    .toggle-group { margin: 10px 0; display: none; }
    .toggle-btn { padding: 6px 12px; border: 1px solid #ccc; background: #f0f0f0; cursor: pointer; border-radius: 4px; margin-right: 5px; }
    .toggle-btn.active { background: #007bff; color: white; }
    #viewToggleSwitch { margin-left: 10px; background:#007bff; color:white; border:none; padding:6px 12px; border-radius:4px; cursor:pointer; }
    /* Modal */
    #storeModal { display:none; position:fixed; top:0; left:0; width:100%; height:100%;
      background:rgba(0,0,0,0.6); display:flex; align-items:center; justify-content:center; }
    #storeModalContent { background:#fff; padding:20px; border-radius:8px; max-width:500px; max-height:80%; overflow:auto; }
    #storeModal h3 { margin-top:0; }
  </style>
</head>
<body>

  <h1>Store Ranging App</h1>
  <button onclick="loadData()">Refresh</button>
  <button id="viewToggleSwitch" onclick="toggleView()">Switch to Store View</button>

  <!-- Store controls -->
  <div id="storeControls" style="display:none;">
    <label for="storeSelect">Select a store:</label>
    <select id="storeSelect" onchange="renderProducts()">
      <option value="">-- Choose a store --</option>
    </select>

    <div class="toggle-group" id="viewToggle">
      <button class="toggle-btn active" id="btnNotRanging" onclick="setView('not ranging')">Not Ranging</button>
      <button class="toggle-btn" id="btnRanging" onclick="setView('ranging')">Ranging</button>
    </div>

    <div id="summary" class="summary">
      <strong>Total Deal Offer Summary:</strong> $<span id="total">0.00</span>
      <ul id="offerList"></ul>
    </div>
  </div>

  <div id="products"></div>

  <!-- Dashboard -->
  <div id="dashboard" style="display:none; margin-top:20px;">
    <h2>Product Dashboard</h2>
    <div id="dashboardContent"></div>
  </div>

  <!-- Modal -->
  <div id="storeModal">
    <div id="storeModalContent">
      <h3 id="modalTitle">Stores Not Ranging</h3>
      <ul id="storeList"></ul>
    </div>
  </div>

  <div>
    <h3>Raw JSON Debug Output</h3>
    <div id="debug">Waiting for data...</div>
  </div>

  <script>
    const scriptUrl = "https://script.google.com/macros/s/AKfycbwixJ_MXyoIF6bTbC5JAY4yXWIkrRmKJd1e6xVbYndSdGHFKUaQ-d8fnWE-edbPq905Pg/exec";
    let allData = [];
    let selectedDeals = {};
    let currentView = "not ranging";
    let currentMode = "dashboard";

    async function loadData() {
      try {
        document.getElementById("debug").textContent = "Loading data...";
        const resp = await fetch(scriptUrl);
        const json = await resp.json();
        allData = json;

        document.getElementById("debug").textContent = JSON.stringify(allData, null, 2);

        populateStores();
        resetSummary();
        showDashboard();
      } catch (err) {
        document.getElementById("debug").textContent = "Error fetching data: " + err;
      }
    }

    function populateStores() {
      const select = document.getElementById("storeSelect");
      select.innerHTML = '<option value="">-- Choose a store --</option>';
      const stores = [...new Set(allData.map(d => d.Store))].sort();
      stores.forEach(storeName => {
        const opt = document.createElement("option");
        opt.value = storeName;
        opt.textContent = storeName;
        select.appendChild(opt);
      });
    }

    function resetSummary() {
      selectedDeals = {};
      updateSummary();
    }

    function setView(view) {
      currentView = view;
      document.getElementById("btnNotRanging").classList.toggle("active", view === "not ranging");
      document.getElementById("btnRanging").classList.toggle("active", view === "ranging");
      renderProducts();
    }

    function renderProducts() {
      document.getElementById("dashboard").style.display = "none";
      document.getElementById("storeControls").style.display = "block";
      const container = document.getElementById("products");
      const summaryBox = document.getElementById("summary");
      const toggleGroup = document.getElementById("viewToggle");

      container.innerHTML = "";

      const storeName = document.getElementById("storeSelect").value;
      if (!storeName) {
        summaryBox.style.display = "none";
        toggleGroup.style.display = "none";
        return;
      } else {
        summaryBox.style.display = "block";
        toggleGroup.style.display = "block";
      }

      const filtered = allData.filter(item => {
        if (item.Store !== storeName) return false;
        const status = String(item.Status).trim().toLowerCase();
        if (currentView === "not ranging") {
          return status === "not ranging";
        }
        if (currentView === "ranging") {
          return status === "ranging" || status === "not buying";
        }
        return false;
      });

      if (filtered.length === 0) {
        container.textContent = "No products found.";
        return;
      }

      filtered.forEach(p => {
        const card = document.createElement("div");
        card.className = "card";

        const img = document.createElement("img");
        img.src = p["Image URL"] || "";
        img.alt = p.Product || "Product";

        const mainLine = document.createElement("div");
        mainLine.className = "main-line";

        const nameEl = document.createElement("strong");
        nameEl.textContent = p.Product || "-";

        const btnDiv = document.createElement("div");
        btnDiv.className = "buttons";

        const btnAdd = document.createElement("button");
        btnAdd.className = "add";
        btnAdd.textContent = "Add to Offer";
        btnAdd.onclick = function(e) {
          e.stopPropagation();
          toggleOffer(btnAdd, p);
        };

        const btnNot = document.createElement("button");
        btnNot.className = "not";
        btnNot.textContent = "Not Buying";
        btnNot.onclick = function(e) {
          e.stopPropagation();
          updateStatus(p, "Not Buying");
        };

        const statusVal = String(p.Status).trim().toLowerCase();
        if (statusVal === "not buying") {
          const btnRestore = document.createElement("button");
          btnRestore.className = "restore";
          btnRestore.textContent = "Restore";
          btnRestore.onclick = function(e) {
            e.stopPropagation();
            updateStatus(p, "Ranging");
          };
          btnDiv.appendChild(btnRestore);
        }

        btnDiv.appendChild(btnAdd);
        btnDiv.appendChild(btnNot);

        mainLine.appendChild(nameEl);
        mainLine.appendChild(btnDiv);

        const rightDiv = document.createElement("div");
        rightDiv.style.flex = "1";
        rightDiv.appendChild(mainLine);

        card.appendChild(img);
        card.appendChild(rightDiv);
        container.appendChild(card);
      });
    }

    function toggleOffer(btn, productObj) {
      const productName = productObj["Product"];
      const dealValue = parseFloat(productObj["50% Deal"]) || 0;

      if (btn.classList.contains("added")) {
        delete selectedDeals[productName];
        btn.classList.remove("added");
        btn.textContent = "Add to Offer";
      } else {
        selectedDeals[productName] = dealValue;
        btn.classList.add("added");
        btn.textContent = "Added";
      }
      updateSummary();
    }

    function updateSummary() {
      const total = Object.values(selectedDeals).reduce((a, b) => a + b, 0);
      document.getElementById("total").textContent = total.toFixed(2);

      const list = document.getElementById("offerList");
      list.innerHTML = "";
      Object.entries(selectedDeals).forEach(([name, value]) => {
        const li = document.createElement("li");
        li.textContent = `${name} - $${value.toFixed(2)}`;
        list.appendChild(li);
      });
    }

    function updateStatus(productObj, newStatus) {
      fetch(scriptUrl, {
        method: "POST",
        body: JSON.stringify({
          Store: productObj.Store,
          Product: productObj.Product,
          Status: newStatus
        }),
        headers: { "Content-Type": "application/json" }
      })
      .then(r => r.text())
      .then(t => {
        console.log("Server response:", t);
        loadData();
      })
      .catch(err => console.error("Error updating sheet:", err));
    }

    function showDashboard() {
      currentMode = "dashboard";
      document.getElementById("dashboard").style.display = "block";
      document.getElementById("products").innerHTML = "";
      document.getElementById("summary").style.display = "none";
      document.getElementById("viewToggle").style.display = "none";
      document.getElementById("storeControls").style.display = "none";
      document.getElementById("viewToggleSwitch").textContent = "Switch to Store View";
      renderDashboard();
    }

    function renderDashboard() {
      const container = document.getElementById("dashboardContent");
      container.innerHTML = "";

      const grouped = {};
      allData.forEach(item => {
        const product = item.Product;
        const status = String(item.Status).trim().toLowerCase();
        if (!grouped[product]) {
          grouped[product] = { product: item, ranging: 0, notRanging: 0, notBuying: 0 };
        }
        if (status === "ranging") grouped[product].ranging++;
        else if (status === "not ranging") grouped[product].notRanging++;
        else if (status === "not buying") grouped[product].notBuying++;
      });

      Object.values(grouped).forEach(g => {
        const card = document.createElement("div");
        card.className = "card";

        const img = document.createElement("img");
        img.src = g.product["Image URL"] || "";
        img.alt = g.product.Product || "Product";

        const nameEl = document.createElement("strong");
        nameEl.textContent = g.product.Product || "-";

        const pill = document.createElement("div");
        pill.style.display = "flex";
        pill.style.border = "1px solid #ccc";
        pill.style.borderRadius = "20px";
        pill.style.overflow = "hidden";
        pill.style.width = "300px";
        pill.style.height = "20px";
        pill.style.marginTop = "8px";

        const total = g.ranging + g.notRanging + g.notBuying || 1;
        const seg = (count, color) => {
          const div = document.createElement("div");
          div.style.width = (count / total * 100) + "%";
          div.style.background = color;
          div.title = count;
          return div;
        };

        pill.appendChild(seg(g.notRanging, "red"));
        pill.appendChild(seg(g.notBuying, "orange"));
        pill.appendChild(seg(g.ranging, "green"));

        const counts = document.createElement("div");
        counts.innerHTML = `ðŸ”´ ${g.notRanging} | ðŸŸ  ${g.notBuying} | ðŸŸ¢ ${g.ranging}`;

        const rightDiv = document.createElement("div");
        rightDiv.style.flex = "1";
        rightDiv.appendChild(nameEl);
        rightDiv.appendChild(pill);
        rightDiv.appendChild(counts);

        card.appendChild(img);
        card.appendChild(rightDiv);

        // click opens modal
        card.onclick = () => {
          showStoreModal(g.product.Product);
        };

        container.appendChild(card);
      });
    }

    function toggleView() {
      if (currentMode === "dashboard") {
        currentMode = "store";
        document.getElementById("dashboard").style.display = "none";
        document.getElementById("storeControls").style.display = "block";
        document.getElementById("viewToggleSwitch").textContent = "Switch to Dashboard";
        renderProducts();
      } else {
        showDashboard();
      }
    }

    function showStoreModal(productName) {
      const modal = document.getElementById("storeModal");
      const title = document.getElementById("modalTitle");
      const list = document.getElementById("storeList");

      title.textContent = `Stores Not Ranging: ${productName}`;
      list.innerHTML = "";

      const stores = allData
        .filter(item => item.Product === productName && String(item.Status).trim().toLowerCase() === "not ranging")
        .map(item => item.Store);

      if (stores.length === 0) {
        const li = document.createElement("li");
        li.textContent = "No stores found.";
        list.appendChild(li);
      } else {
        stores.forEach(s => {
          const li = document.createElement("li");
          li.textContent = s;
          list.appendChild(li);
        });
      }

      modal.style.display = "flex";
    }

    // close modal when clicking outside
    document.getElementById("storeModal").addEventListener("click", function(e) {
      if (e.target.id === "storeModal") {
        this.style.display = "none";
      }
    });

    loadData();
  </script>
</body>
</html>