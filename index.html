<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Store Ranging App</title>
<style>
  :root{
    --ios-bg:#f6f8fb;
    --card:#ffffff;
    --ink:#0a2540;
    --muted:#6b7a90;
    --blue:#147aff;
    --green:#12b886;
    --red:#ff4d4f;
    --orange:#ff9f1a;
    --border:#e6ebf2;
    --chip:#ecf2ff;
  }
  html,body{margin:0;background:var(--ios-bg);color:var(--ink);font:16px -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  .wrap{max-width:980px;margin:0 auto;padding:16px}
  h1{display:flex;gap:10px;align-items:center;font-weight:800;margin:8px 0 14px}
  .toolbar{display:flex;flex-wrap:wrap;gap:12px;margin:8px 0 16px}
  .btn{appearance:none;border:0;border-radius:14px;background:var(--blue);color:#fff;font-weight:700;padding:12px 16px;display:inline-flex;gap:10px;align-items:center;box-shadow:0 6px 16px rgba(20,122,255,.18)}
  .btn.secondary{background:#eef4ff;color:#214b9f;box-shadow:none}
  .select{width:100%;max-width:600px;display:block;padding:12px 14px;border-radius:12px;border:1px solid var(--border);background:#fff}
  .panel{background:#eef6ff;border-radius:14px;padding:14px 16px;margin:14px 0}
  .cards{display:grid;gap:14px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px;display:grid;grid-template-columns:84px 1fr;gap:14px;align-items:center}
  .thumb{width:84px;height:84px;border-radius:12px;background:#eef1f6;display:flex;align-items:center;justify-content:center;overflow:hidden}
  .thumb img{width:100%;height:100%;object-fit:cover}
  .title{font-weight:800;margin:0 0 2px}
  .meta{color:var(--muted);margin:6px 0 0;font-size:14px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .chip-toggle{display:flex;background:#fff;border:1px solid var(--border);border-radius:14px;overflow:hidden}
  .chip-toggle button{border:0;background:transparent;padding:10px 16px;font-weight:700;color:var(--muted)}
  .chip-toggle button.active{background:#f2f6ff;color:#1b4de4}
  .pill{height:12px;background:#e9eef7;border-radius:999px;overflow:hidden}
  .pill > span{display:block;height:100%}
  .dots{display:flex;gap:14px;margin-top:8px}
  .dot{display:flex;align-items:center;gap:6px;color:#223; font-weight:700}
  .dot i{display:inline-block;width:14px;height:14px;border-radius:50%}
  .dot.red i{background:var(--red)}
  .dot.orange i{background:var(--orange)}
  .dot.green i{background:var(--green)}
  details{margin-top:8px}
  summary{cursor:pointer;color:#2d4; font-weight:700}
  pre{white-space:pre-wrap;background:#fff;border:1px solid var(--border);padding:10px;border-radius:10px}
  .hidden{display:none !important}
</style>
</head>
<body>
<div class="wrap">
  <h1>üì± Store Ranging App</h1>

  <div class="toolbar">
    <button id="refreshBtn" class="btn">üîÑ Refresh</button>
    <button id="switchBtn" class="btn secondary">üìä Switch to Dashboard</button>
  </div>

  <!-- DASHBOARD -->
  <section id="dashboardView">
    <h2 style="margin:12px 0 10px;display:flex;align-items:center;gap:8px">üìà Product Dashboard</h2>
    <div id="dashList" class="cards"></div>
  </section>

  <!-- STORE VIEW -->
  <section id="storeView" class="hidden">
    <label for="storeSelect">Select a store:</label>
    <select id="storeSelect" class="select"></select>

    <div class="row" style="margin:12px 0">
      <div class="chip-toggle" role="tablist" aria-label="Status filter">
        <button id="btnNotRanging" class="active" role="tab" aria-selected="true">üî¥ Not Ranging</button>
        <button id="btnRanging" role="tab" aria-selected="false">üü¢ Ranging</button>
      </div>
    </div>

    <div id="summaryPanel" class="panel hidden">
      <strong>Total Deal Offer Summary</strong>
      <div style="font-size:20px;font-weight:800;margin-top:6px" id="summaryTotal">$0.00</div>
    </div>

    <h2 style="margin:14px 0 6px">Products</h2>
    <div id="storeCards" class="cards"></div>

    <details style="margin-top:18px">
      <summary>üõ† Debug Output</summary>
      <pre id="debugOut">loading‚Ä¶</pre>
    </details>
  </section>
</div>

<script>
const scriptUrl = "YOUR_APPS_SCRIPT_URL_HERE"; // <-- replace with your Apps Script URL

// ---------- helpers ----------
const norm = s => (s ?? "").toString().trim();
const normStatus = s => norm(s).toLowerCase();

// status buckets (robust: handles case, spaces, synonyms)
function getBucket(statusRaw){
  const s = normStatus(statusRaw);
  const has = (a)=>s.includes(a);
  const notRanging = has('not') && has('ranging');        // "not ranging"
  const notBuying  = has('not') && has('buying');         // "not buying"
  const ranging    = (has('ranging') || has('buying')) && !notRanging; // "ranging","buying","not buying"
  return { notRanging, notBuying, ranging };
}

function money(n){
  const v = Number(n);
  if(!isFinite(v)) return "$0.00";
  return v.toLocaleString(undefined,{style:"currency",currency:"USD"});
}

// ---------- app state ----------
let rawRows = [];
let productsIndex = new Map(); // product -> meta from Deals (image, prices, etc.)
let storeList = [];
let viewMode = "dashboard"; // "dashboard" | "store"
let storeFilter = "not";    // "not" | "ranging"
let selectedStore = "";

// ---------- DOM refs ----------
const dashList = document.getElementById('dashList');
const storeView = document.getElementById('storeView');
const dashboardView = document.getElementById('dashboardView');
const switchBtn = document.getElementById('switchBtn');
const refreshBtn = document.getElementById('refreshBtn');
const storeSelect = document.getElementById('storeSelect');
const btnNotRanging = document.getElementById('btnNotRanging');
const btnRanging = document.getElementById('btnRanging');
const storeCards = document.getElementById('storeCards');
const debugOut = document.getElementById('debugOut');
const summaryPanel = document.getElementById('summaryPanel');
const summaryTotal = document.getElementById('summaryTotal');

// ---------- load ----------
async function load(){
  try{
    const res = await fetch(`${scriptUrl}?t=${Date.now()}`, {cache:"no-store"});
    const data = await res.json();

    // Expect: { rows:[...], products:[{Product, "Image URL", "50% Deal", ...}] }
    rawRows = Array.isArray(data.rows) ? data.rows : [];
    productsIndex = new Map();
    if(Array.isArray(data.products)){
      for(const p of data.products){
        const key = norm(p.Product);
        if(key) productsIndex.set(key, p);
      }
    }

    // Build store list
    const set = new Set();
    rawRows.forEach(r=>{
      const s = norm(r.Store);
      if(s) set.add(s);
    });
    storeList = Array.from(set).sort((a,b)=>a.localeCompare(b));

    // UI
    renderDashboard();
    renderStoreSelect();
    renderStoreView(); // respects current filter

    debugOut.textContent = JSON.stringify({
      rows: rawRows.length,
      example: rawRows[0],
      productsMeta: productsIndex.size
    }, null, 2);
  }catch(err){
    debugOut.textContent = "Error: " + err;
  }
}

// ---------- dashboard ----------
function renderDashboard(){
  dashList.innerHTML = "";
  // Aggregate per product across all stores
  const tally = new Map(); // product -> {red, orange, green, img}
  for(const r of rawRows){
    const product = norm(r.Product);
    if(!product) continue;
    const t = tally.get(product) || {red:0, orange:0, green:0};
    const b = getBucket(r.Status);
    if(b.notRanging) t.red++;
    else if(b.notBuying) t.orange++;
    else if(b.ranging) t.green++;

    // image
    const meta = productsIndex.get(product);
    if(meta && !t.img) t.img = norm(meta["Image URL"]);
    tally.set(product, t);
  }

  const items = Array.from(tally.entries()).sort((a,b)=>b[1].red - a[1].red);
  for(const [product, t] of items){
    const total = t.red + t.orange + t.green || 1;
    const redPct = (t.red/total)*100;
    const orangePct = (t.orange/total)*100;
    const greenPct = 100 - redPct - orangePct;

    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <div class="thumb">${t.img ? `<img src="${t.img}" alt="">` : "üñºÔ∏è"}</div>
      <div>
        <div class="title">${product}</div>
        <div class="pill" style="margin-top:10px">
          <span style="width:${redPct}%;background:var(--red)"></span>
        </div>
        <div class="dots">
          <div class="dot red"><i></i>${t.red}</div>
          <div class="dot orange"><i></i>${t.orange}</div>
          <div class="dot green"><i></i>${t.green}</div>
        </div>
      </div>
    `;
    // Click -> popup of stores not ranging
    card.style.cursor = "pointer";
    card.addEventListener('click', ()=>{
      const notRangingStores = rawRows
        .filter(r=>norm(r.Product)===product && getBucket(r.Status).notRanging)
        .map(r=>norm(r.Store))
        .sort((a,b)=>a.localeCompare(b));

      const list = notRangingStores.length
        ? `<ul>${notRangingStores.map(s=>`<li>${s}</li>`).join("")}</ul>`
        : `<em>All stores are buying/ranging.</em>`;

      const modal = document.createElement('div');
      Object.assign(modal.style,{
        position:'fixed',inset:'0',background:'rgba(0,0,0,.35)',display:'grid',placeItems:'center',zIndex:9999
      });
      const sheet = document.createElement('div');
      Object.assign(sheet.style,{
        background:'#fff',borderRadius:'16px',maxWidth:'560px',width:'92%',padding:'18px',boxShadow:'0 10px 40px rgba(0,0,0,.2)'
      });
      sheet.innerHTML = `<h3 style="margin:0 0 10px">${product}</h3>
                         <div style="color:var(--muted);margin-bottom:10px">Stores not ranging</div>
                         <div style="max-height:60vh;overflow:auto">${list}</div>
                         <div style="text-align:center;margin-top:12px;color:#8894aa"><small>Tap anywhere to close</small></div>`;
      modal.appendChild(sheet);
      modal.addEventListener('click', ()=>modal.remove());
      document.body.appendChild(modal);
    });

    dashList.appendChild(card);
  }
}

// ---------- store view ----------
function renderStoreSelect(){
  storeSelect.innerHTML = `<option value="">-- Choose a store --</option>` +
    storeList.map(s=>`<option>${s}</option>`).join('');
  // keep previous selection if still present
  if(selectedStore && storeList.includes(selectedStore)){
    storeSelect.value = selectedStore;
  }
}

function renderStoreView(){
  // show/hide sections
  dashboardView.classList.toggle('hidden', viewMode!=="dashboard");
  storeView.classList.toggle('hidden', viewMode!=="store");

  const store = selectedStore = norm(storeSelect.value);
  const rowsForStore = rawRows.filter(r=>norm(r.Store)===store);

  // counters (debug & optional future use)
  const counts = { notRanging:0, notBuying:0, ranging:0 };
  for(const r of rowsForStore){
    const b = getBucket(r.Status);
    if(b.notRanging) counts.notRanging++;
    else if(b.notBuying) counts.notBuying++;
    else if(b.ranging) counts.ranging++;
  }

  // Filter by current chip
  let list = rowsForStore.filter(r=>{
    const b = getBucket(r.Status);
    return (storeFilter==="not") ? b.notRanging : (b.ranging || b.notBuying);
  });

  // Render cards
  storeCards.innerHTML = "";
  if(!store){ summaryPanel.classList.add('hidden'); return; }
  summaryPanel.classList.remove('hidden'); // visible only when a store is chosen

  if(list.length === 0){
    storeCards.innerHTML = `<div class="meta">No products found.</div>`;
  }else{
    for(const r of list){
      const product = norm(r.Product);
      const meta = productsIndex.get(product) || {};
      const img = norm(meta["Image URL"]);
      const deal = meta["50% Deal"];
      const price = meta["List Price"];

      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `
        <div class="thumb">${img ? `<img src="${img}" alt="">` : "üñºÔ∏è"}</div>
        <div>
          <div class="title">${product}</div>
          <div class="meta">Metcash Code: ${meta["Metcash Code"]||"-"}</div>
          <div class="meta">List Price: ${price ? money(price) : "-"}</div>
          <div class="meta">50% Deal: ${deal ? money(deal) : "-"}</div>
        </div>
      `;
      storeCards.appendChild(card);
    }
  }

  // Debug info
  debugOut.textContent = JSON.stringify({store, filter:storeFilter, counts, sample:list[0]}, null, 2);

  // Recalc total deal for items marked ‚ÄúAdd to Offer‚Äù later (placeholder for your logic)
  summaryTotal.textContent = "$0.00";
}

// ---------- events ----------
switchBtn.addEventListener('click', ()=>{
  viewMode = (viewMode==="dashboard") ? "store" : "dashboard";
  switchBtn.textContent = (viewMode==="dashboard") ? "üìä Switch to Store View" : "üè† Switch to Dashboard";
  renderStoreView();
  renderDashboard();
});
refreshBtn.addEventListener('click', load);
storeSelect.addEventListener('change', ()=>{ renderStoreView(); });

btnNotRanging.addEventListener('click', ()=>{
  storeFilter = "not";
  btnNotRanging.classList.add('active');
  btnRanging.classList.remove('active');
  renderStoreView();
});
btnRanging.addEventListener('click', ()=>{
  storeFilter = "ranging";
  btnRanging.classList.add('active');
  btnNotRanging.classList.remove('active');
  renderStoreView();
});

// ---------- start ----------
load();
</script>
</body>
</html>